<!DOCTYPE html>
<html>
<head>
	<!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
	<meta name="google-signin-client_id" content="956956950540-qkifems6t6ie5sp47vs9hfmi94par1bc.apps.googleusercontent.com">
	<title>Plain Email</title>
	<link rel="stylesheet" href="css/style.css">
	<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
	<script src="https://apis.google.com/js/platform.js" async defer></script>
	<script src="https://apis.google.com/js/client.js?onload=checkAuth" async defer></script>
	<script type="text/javascript">
		var CLIENT_ID = '956956950540-qkifems6t6ie5sp47vs9hfmi94par1bc.apps.googleusercontent.com';
	    var apiKey = 'AIzaSyBOHcY998qIe5lY_w3iwAcothkBCLUO1To';
	    var SCOPES = ['https://mail.google.com/', 'https://www.googleapis.com/auth/gmail.readonly'];

		function showContentDiv() {
			var element = document.getElementById("contentDiv");
			// var id = item.dataset.id;
			// var element = document.getElementById(id);
			if (element.style.display === "none") {
				element.style.display = "block";
			}
			else
				element.style.display = "none";
		}
		function onSignIn() {
			document.getElementById("signInDiv").style.display = "none";
			document.getElementById("signOutDiv").style.display = "block";
			document.getElementById("main").style.display = "block";
			document.getElementById("mainDiv").style.display = "block";
			//checkAuth();
		}
		function signOut() {
			var auth2 = gapi.auth2.getAuthInstance();
  			auth2.signOut().then(function () {//alert("inside signOut");
    			console.log('User signed out.');
  				});
  			document.getElementById("main").style.display = "none";
  			document.getElementById("signInDiv").style.display = "block";
  			document.getElementById("signOutDiv").style.display = "none";
		}
		function checkAuth() {//alert("hello");
        gapi.auth.authorize(
          {
            'client_id': CLIENT_ID,
            'scope': SCOPES.join(' '),
            'immediate': true
          }, handleAuthResult);
        }
        function handleAuthResult(authResult) {//alert("handleAuthResult");
	        // var authorizeDiv = document.getElementById('authorize-div');
	        if (authResult && !authResult.error) {
	          // Hide auth UI, then load client library.
	          // authorizeDiv.style.display = 'none';
	          loadGmailApi();
	        } 
        }
        function handleAuthClick(event) {
	        gapi.auth.authorize(
	          {client_id: CLIENT_ID, scope: SCOPES, immediate: false},
	          handleAuthResult);
	        return false;
        }
        function loadGmailApi() {
       		gapi.client.load('gmail', 'v1', displayMessages);
      	}
      	function checkLabel() {
      		listLabels('Done');
      		listLabels('Respond');
      		listLabels('Delegate');
      		listLabels('Defer');
      	}
      	function listLabels(labelName) {//alert("listLabels " + labelName);
      		var found = false;
	        var request = gapi.client.gmail.users.labels.list({
	          'userId': 'me'
	        });
	        var arr = [];
	        request.execute(function(resp) {
	          var labels = resp.labels;
	          

	          if (labels && labels.length > 0) {
	            for (i = 0; i < labels.length; i++) {
	              var label = labels[i];
	              
	              arr[i] = label.name;
	              //console.log(arr[i]);
	            }
	          }
	          for (var j = 0; j < arr.length; j++)  {
	          	if (arr[j] === labelName) {
	          		found = true;
	          		break;
	          	}
	          }
	          if (!found) {
	          		console.log(labelName);
	          		createLabel(labelName);
	          		
	          	}
	        });
      	}
      	function createLabel(newLabelName) {//alert("createLabel");
	        var request = gapi.client.gmail.users.labels.create({
	          'userId': 'me', 
	          'resource': {
	            'name': newLabelName,
	            'messageListVisibility': 'show',
	            'labelListVisibility': 'labelShow'

	          }
	        });
	        request.execute(function(resp){
	        	console.log("label created");
	        });
      	}
      	function displayMessages(){
      		checkLabel();
	        var request = gapi.client.gmail.users.messages.list({
	          'userId': 'me',
	          'labelIds': 'UNREAD',
	          'maxResults': 5
	        });
	        request.execute(function(response){
	          $.each(response.messages, function() {
	            var msgReq = gapi.client.gmail.users.messages.get({
	             'userId': 'me',
	             'id': this.id
	            });
	            msgReq.execute(addMessageRow);
	            // msgReq.execute(createUI);
	          });
	        });
      	}
      	function addMessageRow(message) { //alert("addMessageRow");
      		document.getElementById("fromDiv").innerHTML = getHeader(message.payload.headers, 'From');
      		document.getElementById("subject").innerHTML = getHeader(message.payload.headers, 'Subject');
      		var day = getHeader(message.payload.headers, 'Date');
      		document.getElementById("dateDiv").innerHTML = getDateTime(day);
      		document.getElementById("messageDiv").innerHTML = getMessageBody(message.payload);
      		// createSubjectLink(message);
      		var element = document.getElementById("mainDiv");
      		// var newDiv = cloneNodeWithEvents(element);
      		var newDiv = element.cloneNode(true);
      		newDiv.id = "mainDiv" + message.id;
      		element.parentNode.appendChild(newDiv);
      	}

      	function getDateTime(timeStamp) {
      		// var currentDate = new Date();
      		// var currentTime = currentDate.getTime();
      		var arr = timeStamp.split(' ');
      		var date1 = arr[1] + arr[2];
      		return date1;
      	}
      	function getHeader(headers, index) {
	        var header = '';   
	        headers.forEach(function(item) {
	          if(item.name.toLowerCase() === index.toLowerCase()) {
	            header = item.value;
	          }
	        });
	        return header;
      	}
      	function getMessageBody(message) {//alert("getMessageBody");
	      //console.log(message);
	        var encodedBody = '';
	        if(typeof message.parts === 'undefined')
	        {
	          encodedBody = message.body.data;
	        }
	        else
	        {
	          encodedBody = getHTMLPart(message.parts);
	        }
	        encodedBody = encodedBody.replace(/-/g, '+').replace(/_/g, '/').replace(/\s/g, '');
	        //console.log(decodeURIComponent(escape(window.atob(encodedBody))));
	        return decodeURIComponent(escape(window.atob(encodedBody)));
      	}

        function getHTMLPart(arr) {
	        for(var x = 0; x <= arr.length; x++)
	        {
		        if(typeof arr[x].parts === 'undefined')
		        {
		            if(arr[x].mimeType === 'text/html')
		            {
		              return arr[x].body.data;
		            }
		        }
		        else
		        {
		            return getHTMLPart(arr[x].parts);
		        }
	        }
	        return '';
        }
        
	</script>
</head>
<body>
	<div id="signInDiv" class="g-signin2" data-onsuccess="onSignIn">
	</div>
	<!-- <button onclick="createUI()">click</button> -->
	<div id="signOutDiv" class="signOutDiv" style="display: none;">
			<a id="signOut" href="#" onclick="signOut();">Sign out</a>
	</div>
	<div id="main" class= "main" style="display: none;">
		<div id="mainDiv" class="mainDiv" style="display: none;">
			<div id="headerDiv" class="headerDiv">
				<div id="fromDiv" class="fromDiv inline">
				</div>
				<div id="subjectDiv" class="subjectDiv inline">
					<a href="javascript:;" id="subject" onclick="showContentDiv()"></a>
				</div>
				<div id="dateDiv" class="dateDiv inline">
				</div>
			</div>
			<div id="contentDiv" class="contentDiv" style="display: none;">
				<div id="messageDiv" class="messageDiv">
				</div>
				<div id="footerDiv" class="footerDiv">
					<button class="button">Done</button>
					<button class="button">Respond</button>
					<button class="button">Delegate</button>
					<button class="button">Defer</button>
				</div>
			</div>
		</div>
	</div>
</body>
</html>